  // prisma/schema.prisma - SCHEMA COMPLETO CORREGIDO

  generator client {
    provider = "prisma-client-js"
  }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }

  // ‚≠ê CONFIGURACI√ìN PARA RAILWAY - Seed autom√°tico
  // Este generator ejecutar√° el seed cuando uses "prisma db seed"
  // Requiere que definas PRISMA_SEED_SCRIPT en tu package.json

  /**
  * ============================================
  * SECCI√ìN 1: AUTENTICACI√ìN Y ROLES
  * ============================================
  */

  /**
  * Tipo de rol base del sistema
  * Define la categor√≠a principal de cada rol
  */
  enum RoleType {
    ADMIN // Administradores del sistema
    TEACHER // Docentes/Maestros (pueden ser maestros gu√≠a)
    COORDINATOR // Coordinadores acad√©micos
    PARENT // Padres/Tutores
    STUDENT // Estudiantes
    STAFF // Personal administrativo
    CUSTOM // Roles personalizados
  }

  /**
  * Estado de matr√≠cula
  * Define el ciclo de vida de una matr√≠cula de estudiante
  */
  enum EnrollmentStatus {
    ACTIVE // Matriculado y activo
    SUSPENDED // Suspendido temporalmente
    INACTIVE // Dado de baja
    TRANSFERRED // Transferido a otro ciclo
  }

  model Role {
    id          Int      @id @default(autoincrement())
    name        String   @unique
    description String?
    roleType    RoleType @default(CUSTOM) // ‚≠ê NUEVO: Define el tipo base del rol
    isActive    Boolean  @default(true)
    isSystem    Boolean  @default(false)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    createdById  Int?
    modifiedById Int?

    createdBy  User? @relation("CreatedRoles", fields: [createdById], references: [id])
    modifiedBy User? @relation("ModifiedRoles", fields: [modifiedById], references: [id])

    permissions           RolePermission[]
    attendancePermissions RoleAttendancePermission[] @relation("RoleAttendancePermissions")
    users                 User[]

    @@map("roles")
  }

  model Permission {
    id                  Int              @id @default(autoincrement())
    module              String
    action              String
    description         String?
    isActive            Boolean          @default(true)
    isSystem            Boolean          @default(false)
    allowedScopes       String[]         @default(["all"])
    requiredPermissions Int[]            @default([])
    createdAt           DateTime         @default(now())
    updatedAt           DateTime         @updatedAt
    roles               RolePermission[]

    @@unique([module, action], name: "module_action")
    @@map("permissions")
  }

  model RolePermission {
    role         Role       @relation(fields: [roleId], references: [id])
    roleId       Int
    permission   Permission @relation(fields: [permissionId], references: [id])
    permissionId Int

    scope    String @default("all")
    metadata Json?

    createdAt DateTime @default(now())

    @@id([roleId, permissionId])
    @@map("role_permissions")
  }

  /**
  * ============================================
  * SECCI√ìN 2: USUARIOS Y PERFILES
  * ============================================
  */

  model User {
    id            Int       @id @default(autoincrement())
    username      String?   @unique
    email         String?   @unique
    password      String
    dpi           String    @unique
    nit           String?
    givenNames    String
    lastNames     String
    phone         String?
    birthDate     DateTime?
    gender        String?
    lastLogin     DateTime?
    loginAttempts Int       @default(0)

    // ‚≠ê PASSWORD RESET FIELDS
    resetToken       String?   @unique
    resetTokenExpires DateTime?
    resetRequestedAt DateTime?

    accountVerified   Boolean @default(false)
    isActive          Boolean @default(true)
    canAccessPlatform Boolean @default(false)

    role   Role? @relation(fields: [roleId], references: [id])
    roleId Int?

    createdRoles  Role[] @relation("CreatedRoles")
    modifiedRoles Role[] @relation("ModifiedRoles")

    address   Address? @relation(fields: [addressId], references: [id])
    addressId Int?

    pictures Picture[]
    children ParentChildLink[] @relation("Parent")

    parentDetails  ParentDetails?
    teacherDetails TeacherDetails?

    guidedSections Section[] @relation("SectionToTeacher")

    courseAssignments  CourseAssignment[] @relation("CourseAssignment")
    schedulePrimary    Schedule[]         @relation("TeacherSchedulePrimary")
    scheduleSubstitute Schedule[]         @relation("TeacherScheduleSubstitute")

    gradedSubmissions AssignmentSubmission[] @relation("SubmissionGrader")

    ericaEvaluations EricaEvaluation[] @relation("EricaTeacher")
    ericaTopics      EricaTopic[]      @relation("TopicTeacher")

    absences         TeacherAbsence[] @relation("TeacherAbsence")
    absencesApproved TeacherAbsence[] @relation("ApprovedBy")

    leaveRequests  TeacherLeaveRequest[] @relation("TeacherLeaveRequest")
    leaveApprovals TeacherLeaveRequest[] @relation("ApprovedLeaveBy")

    attendances TeacherAttendance[] @relation("TeacherAttendanceRecord")

    assignmentHistory         CourseAssignmentHistory[] @relation("AssignedHistory")
    assignmentHistoryApproved CourseAssignmentHistory[] @relation("ChangedBy")

    createdCycles  SchoolCycle[] @relation("CreatedCycles")
    modifiedCycles SchoolCycle[] @relation("ModifiedCycles")
    archivedCycles SchoolCycle[] @relation("ArchivedCycles") // ‚≠ê CAMBIO

    // ‚ú® RELACIONES DE ASISTENCIA DE ESTUDIANTES
    recordedClassAttendances StudentClassAttendance[]  @relation("RecordedByClassAttendance")
    modifiedClassAttendances StudentClassAttendance[]  @relation("ModifiedByClassAttendance")
    justificationsApproved   StudentJustification[]    @relation("JustificationApprovedBy")
    justificationsSubmitted  StudentJustification[]    @relation("JustificationSubmittedBy")

    metadataCreatedById     Int?
    metadataLastUpdatedById Int?
    metadataLastUpdatedAt   DateTime?

    // ‚ú® RELACIONES DE MATR√çCULAS (Auditor√≠a)
    createdEnrollments  Enrollment[] @relation("EnrollmentsCreated")
    modifiedEnrollments Enrollment[] @relation("EnrollmentsModified")

    // ‚≠ê RELACIONES DE FIRMAS PARA CARTAS DE NOTAS
    signatures Signature[] @relation("UserSignatures")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([roleId])
    @@map("users")
  }

  /**
  * ============================================
  * SECCI√ìN 2: UBICACI√ìN (DEPARTAMENTOS Y MUNICIPIOS)
  * ============================================
  */

  model Department {
    id             Int            @id @default(autoincrement())
    name           String         @unique
    code           String         @unique
    municipalities Municipality[]
    addresses      Address[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("departments")
  }

  model Municipality {
    id           Int        @id @default(autoincrement())
    name         String
    code         String     @unique
    departmentId Int
    department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
    addresses    Address[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([departmentId, name])
    @@map("municipalities")
  }

  model Address {
    id     Int     @id @default(autoincrement())
    street String?
    zone   String?

    municipalityId Int?
    departmentId   Int?

    municipality Municipality? @relation(fields: [municipalityId], references: [id], onDelete: SetNull)
    department   Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)

    user     User[]
    students Student[]

    @@map("addresses")
  }

  model ParentDetails {
    id     Int  @id @default(autoincrement())
    userId Int  @unique
    user   User @relation(fields: [userId], references: [id])

    dpiIssuedAt String?
    email       String?
    workPhone   String?

    isSponsor   Boolean @default(false)
    sponsorInfo String?
    occupation  String?
    workplace   String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("parent_details")
  }

  model TeacherDetails {
    id                Int      @id @default(autoincrement())
    userId            Int      @unique
    user              User     @relation(fields: [userId], references: [id])
    hiredDate         DateTime
    isHomeroomTeacher Boolean
    academicDegree    String?

    @@map("teacher_details")
  }

  model Picture {
    id          Int      @id @default(autoincrement())
    publicId    String
    kind        String
    url         String
    description String?
    uploadedAt  DateTime @default(now())

    userId Int?
    user   User? @relation(fields: [userId], references: [id])

    studentId Int?
    student   Student? @relation(fields: [studentId], references: [id])

    @@map("pictures")
  }

  /**
  * ============================================
  * SECCI√ìN 3: ESTUDIANTES
  * ============================================
  */

  model Student {
    id                       Int      @id @default(autoincrement())
    codeSIRE                 String?  @unique
    givenNames               String
    lastNames                String
    birthDate                DateTime
    birthPlace               String?
    birthTown                String?
    nationality              String?
    gender                   String?
    nativeLanguage           String?
    secondLanguage           String?
    livesWithText            String?
    financialResponsibleText String?
    siblingsCount            Int      @default(0)
    brothersCount            Int      @default(0)
    sistersCount             Int      @default(0)
    favoriteColor            String?
    hobby                    String?
    favoriteFood             String?
    favoriteSubject          String?
    favoriteToy              String?
    favoriteCake             String?
    
    // ==================== INFORMACI√ìN ADICIONAL ====================
    ethnicity    String?  // Ladino, Maya, Garifuna, etc.
    hasLibrary   Boolean? @default(false)
    hasLunches   Boolean? @default(false)

    address   Address? @relation(fields: [addressId], references: [id])
    addressId Int?

    enrollments Enrollment[]

    medicalInfo       MedicalInfo?
    academicRecords   AcademicRecord[]
    busService        BusService?
    parents           ParentChildLink[]
    authorizedPersons AuthorizedPerson[]
    sponsorships      Sponsorship[]
    emergencyContacts EmergencyContact[]
    siblings          Sibling[]
    pictures          Picture[]
    submissions       AssignmentSubmission[] @relation("SubmissionStudent")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("students")
  }

  model MedicalInfo {
    id                         Int      @id @default(autoincrement())
    studentId                  Int      @unique
    student                    Student  @relation(fields: [studentId], references: [id])
    hasDisease                 Boolean  @default(false)
    diseaseDetails             String?
    takesMedication            Boolean  @default(false)
    medicationDetails          String?
    hasAllergies               Boolean  @default(false)
    allergiesDetails           String?
    emergencyMedicationAllowed Boolean  @default(false)
    hasLearningDisability      Boolean  @default(false)
    disabilityDetails          String?
    strengths                  String?
    areasToImprove             String?
    createdAt                  DateTime @default(now())
    updatedAt                  DateTime @updatedAt

    @@map("medical_infos")
  }

  model AcademicRecord {
    id              Int      @id @default(autoincrement())
    studentId       Int
    student         Student  @relation(fields: [studentId], references: [id])
    schoolName      String
    gradeCompleted  String
    gradePromotedTo String
    year            Int
    createdAt       DateTime @default(now())

    @@map("academic_records")
  }

  model BusService {
    id                      Int       @id @default(autoincrement())
    studentId               Int       @unique
    student                 Student?  @relation(fields: [studentId], references: [id])
    hasService              Boolean   @default(false)
    pickupPersonName        String?
    dropoffPersonName       String?
    homeAddress             String?
    referencePoints         String?
    emergencyContact        String?
    emergencyDeliveryPerson String?
    route                   String?
    monthlyFee              Float?
    acceptedRules           Boolean   @default(false)
    signedDate              DateTime?
    createdAt               DateTime  @default(now())
    updatedAt               DateTime  @updatedAt

    @@map("bus_services")
  }

  model AuthorizedPerson {
    id           Int      @id @default(autoincrement())
    studentId    Int
    student      Student  @relation(fields: [studentId], references: [id])
    name         String
    relationship String
    phone        String?
    createdAt    DateTime @default(now())

    @@map("authorized_persons")
  }

  model Sponsorship {
    id          Int      @id @default(autoincrement())
    studentId   Int
    student     Student  @relation(fields: [studentId], references: [id])
    sponsorName String?
    preferences Json?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@map("sponsorships")
  }

  model Sibling {
    id         Int     @id @default(autoincrement())
    name       String
    age        Int
    gender     String?
    birthOrder Int?
    studentId  Int
    student    Student @relation(fields: [studentId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("siblings")
  }

  model ParentChildLink {
    id               Int     @id @default(autoincrement())
    parentId         Int
    studentId        Int
    parent           User    @relation("Parent", fields: [parentId], references: [id])
    student          Student @relation(fields: [studentId], references: [id])
    relationshipType String
    isPrimaryContact Boolean @default(false)
    hasLegalCustody  Boolean @default(false)
    canAccessInfo    Boolean @default(true)

    livesWithStudent     Boolean @default(false)
    financialResponsible Boolean @default(false)

    emergencyContactPriority Int?    @default(1)
    receivesSchoolNotices    Boolean @default(true)

    @@unique([parentId, studentId])
    @@map("parent_child_links")
  }

  model EmergencyContact {
    id           Int     @id @default(autoincrement())
    name         String
    relationship String
    phone        String
    priority     Int?    @default(1)
    studentId    Int
    student      Student @relation(fields: [studentId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("emergency_contacts")
  }

  /**
  * ============================================
  * SECCI√ìN 4: CICLOS Y BIMESTRES
  * ============================================
  */

  model SchoolCycle {
    id        Int      @id @default(autoincrement())
    name      String   @unique
    startDate DateTime
    endDate   DateTime

    isActive   Boolean @default(false)
    isArchived Boolean @default(false) // ‚≠ê CAMBIO
    canEnroll  Boolean @default(false)

    // ‚≠ê CAMPOS FALTANTES:
    description  String? // Descripci√≥n adicional
    academicYear Int? // Ej: 2025 (para b√∫squedas/filtros)

    archivedAt    DateTime? // ‚≠ê CAMBIO
    archivedBy    Int? // ‚≠ê CAMBIO
    archiveReason String? // ‚≠ê CAMBIO

    updatedAt DateTime? @updatedAt // Auditor√≠a de cambios

    createdById  Int? // ¬øQui√©n lo cre√≥?
    modifiedById Int? // ¬øQui√©n lo modific√≥ √∫ltimo?

    // Relaciones de auditor√≠a
    createdBy      User? @relation("CreatedCycles", fields: [createdById], references: [id])
    modifiedBy     User? @relation("ModifiedCycles", fields: [modifiedById], references: [id])
    archivedByUser User? @relation("ArchivedCycles", fields: [archivedBy], references: [id])

    createdAt DateTime @default(now())

    bimesters   Bimester[]
    grades      GradeCycle[]
    enrollments Enrollment[]

    // ‚≠ê RELACIONES DE FIRMAS PARA CARTAS DE NOTAS
    signatures Signature[] @relation("SignaturesCycle")

    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([isActive, isArchived, startDate, endDate], name: "idx_school_cycles_active_dates")
    @@map("school_cycles")
  }

  model Bimester {
    id         Int      @id @default(autoincrement())
    cycleId    Int
    number     Int      @default(1)
    name       String
    startDate  DateTime
    endDate    DateTime
    isActive   Boolean  @default(false)
    weeksCount Int      @default(8)

    cycle    SchoolCycle    @relation(fields: [cycleId], references: [id])
    holidays Holiday[]
    weeks    AcademicWeek[]
    grades   StudentGrade[]

    assignments Assignment[]

    ericaEvaluations  EricaEvaluation[]       @relation("EricaBimester")
    ericaAverages     EricaAverage[]          @relation("AverageBimester")
    calculatedResults EricaCalculatedResult[] @relation("CalculatedBimester")

    attendanceReports StudentAttendanceReport[] @relation("ReportBimester")

    @@unique([cycleId, number])
    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([cycleId, isActive], name: "idx_bimesters_cycle_active")
    @@map("bimesters")
  }

  model Holiday {
    id          Int      @id @default(autoincrement())
    bimesterId  Int
    date        DateTime
    description String
    isRecovered Boolean  @default(false)

    bimester Bimester @relation(fields: [bimesterId], references: [id])

    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([bimesterId, date], name: "idx_holidays_bimester_date")
    @@map("holidays")
  }

  enum WeekType {
    REGULAR
    EVALUATION
    REVIEW
    BREAK
  }

  model AcademicWeek {
    id         Int      @id @default(autoincrement())
    bimesterId Int
    number     Int
    startDate  DateTime
    endDate    DateTime
    objectives String?
    weekType   WeekType @default(REGULAR)

    ericaEvaluations EricaEvaluation[] @relation("EricaAcademicWeek")
    ericaTopics      EricaTopic[]      @relation("TopicWeek")

    bimester Bimester @relation(fields: [bimesterId], references: [id])

    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([bimesterId, startDate, endDate], name: "idx_academic_weeks_date_range")
    @@map("academic_weeks")
  }

  /**
  * ============================================
  * SECCI√ìN 5: SISTEMA ERICA (EVALUACIONES)
  * ============================================
  */

  /**
  * ‚≠ê ENUMS PARA SISTEMA ERICA
  */
  enum EricaDimension {
    EJECUTA   // E = Ejecuta
    RETIENE   // R = Retiene
    INTERPRETA // I = Interpreta
    CONOCE    // C = Conoce
    AMPLIA    // A = Ampl√≠a
  }

  enum EricaState {
    E  // Excelente = 1 pto
    B  // Bien = 0.75 ptos
    P  // Poco = 0.50 ptos
    C  // Casi nada = 0.25 ptos
    N  // Nada = 0 ptos
  }

  /**
  * ‚≠ê MAPEO DE DIMENSIONES ERICA POR D√çA DE LA SEMANA
  * Relaciona cada d√≠a (L-M-M-J-V) con una dimensi√≥n (E-R-I-C-A)
  * 
  * Ejemplo:
  * - Lunes (1) ‚Üí EJECUTA
  * - Martes (2) ‚Üí RETIENE
  * - Mi√©rcoles (3) ‚Üí INTERPRETA
  * - Jueves (4) ‚Üí CONOCE
  * - Viernes (5) ‚Üí AMPLIA
  */
  model EricaDimensionDay {
    id        Int            @id @default(autoincrement())
    dayOfWeek Int            // 1=Lunes, 2=Martes, 3=Mi√©rcoles, 4=Jueves, 5=Viernes
    dimension EricaDimension // EJECUTA, RETIENE, INTERPRETA, CONOCE, AMPLIA
    order     Int            // 1, 2, 3, 4, 5
    
    isActive Boolean @default(true)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([dayOfWeek, dimension])
    @@index([dayOfWeek])
    @@index([dimension])
    @@map("erica_dimension_days")
  }

  /**
  * ‚≠ê TABLA DE COLORES PARA DIMENSIONES ERICA
  * Mapea colores a cada dimensi√≥n (E, R, I, C, A)
  * Permite cambiar colores sin modificar c√≥digo
  * 
  * Ejemplo:
  * - EJECUTA ‚Üí Verde (#00AA00)
  * - RETIENE ‚Üí Azul (#0000FF)
  * - INTERPRETA ‚Üí Morado (#800080)
  * - CONOCE ‚Üí Naranja (#FFA500)
  * - AMPLIA ‚Üí Rojo (#FF0000)
  */
  model EricaDimensionColor {
    id        Int            @id @default(autoincrement())
    dimension EricaDimension @unique // EJECUTA, RETIENE, INTERPRETA, CONOCE, AMPLIA
    
    colorCode String @db.VarChar(7) // Ej: #00AA00
    colorName String                // Ej: "Verde Oscuro"
    hexCode   String @db.VarChar(7) // Alternativo a colorCode
    
    isActive Boolean @default(true)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([dimension])
    @@map("erica_dimension_colors")
  }

  /**
  * ‚≠ê TABLA DE COLORES PARA ESTADOS ERICA
  * Mapea colores a cada estado (E, B, P, C, N)
  * Permite cambiar colores sin modificar c√≥digo
  * 
  * Ejemplo:
  * - E (Excelente) ‚Üí Verde Claro (#90EE90)
  * - B (Bien) ‚Üí Verde Oscuro (#006400)
  * - P (Poco) ‚Üí Amarillo (#FFFF00)
  * - C (Casi nada) ‚Üí Naranja (#FFA500)
  * - N (Nada) ‚Üí Rojo (#FF0000)
  */
  model EricaStateColor {
    id    Int @id @default(autoincrement())
    state EricaState @unique // E, B, P, C, N
    
    colorCode String @db.VarChar(7) // Ej: #90EE90
    colorName String                // Ej: "Verde Claro"
    hexCode   String @db.VarChar(7) // Alternativo a colorCode
    
    isActive Boolean @default(true)
    
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    
    @@index([state])
    @@map("erica_state_colors")
  }

  /**
  * ‚≠ê TEMAS POR SEMANA ACAD√âMICA
  * Define el tema principal de cada semana acad√©mica
  * Por curso y secci√≥n
  * 
  * Ejemplo:
  * - Semana 1: "Sumas"
  * - Semana 2: "Restas"
  * - Semana 3: "Multiplicaci√≥n"
  */
  model EricaTopic {
    id             Int @id @default(autoincrement())
    courseId       Int
    academicWeekId Int
    sectionId      Int
    teacherId      Int

    // ‚≠ê NUEVO: Tema de la semana (ej: "Sumas", "An√°lisis de Textos")
    weekTheme       String
    
    title           String?
    description     String?
    objectives      String?
    materials       String?

    isActive        Boolean @default(true)
    isCompleted     Boolean @default(false)

    course          Course       @relation("TopicCourse", fields: [courseId], references: [id])
    academicWeek    AcademicWeek @relation("TopicWeek", fields: [academicWeekId], references: [id])
    section         Section      @relation("TopicSection", fields: [sectionId], references: [id])
    teacher         User         @relation("TopicTeacher", fields: [teacherId], references: [id])

    evaluations EricaEvaluation[] @relation("EvaluationTopic")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([courseId, academicWeekId, sectionId], name: "unique_course_week_section_topic")
    @@index([courseId])
    @@index([academicWeekId])
    @@map("erica_topics")
  }

  /**
  * ‚≠ê EVALUACIONES ERICA POR DIMENSI√ìN
  * 
  * Estructura:
  * - Un estudiante (enrollment) tiene UNA evaluaci√≥n por cada dimensi√≥n ERICA (E, R, I, C, A) por semana
  * - Cada dimensi√≥n se califica con un estado (E, B, P, C, N) que tiene puntos asociados
  * - El d√≠a de la semana mapea autom√°ticamente a la dimensi√≥n seg√∫n EricaDimensionDay
  * 
  * Flujo:
  * - Lunes (1) ‚Üí EJECUTA ‚Üí Estado EBPCN ‚Üí Puntos
  * - Martes (2) ‚Üí RETIENE ‚Üí Estado EBPCN ‚Üí Puntos
  * - Mi√©rcoles (3) ‚Üí INTERPRETA ‚Üí Estado EBPCN ‚Üí Puntos
  * - Jueves (4) ‚Üí CONOCE ‚Üí Estado EBPCN ‚Üí Puntos
  * - Viernes (5) ‚Üí AMPLIA ‚Üí Estado EBPCN ‚Üí Puntos
  */
  model EricaEvaluation {
    id             Int @id @default(autoincrement())
    
    // üîë Identificadores principales
    enrollmentId   Int
    courseId       Int
    bimesterId     Int
    academicWeekId Int
    topicId        Int
    teacherId      Int

    // ‚≠ê Dimensi√≥n ERICA (EJECUTA, RETIENE, INTERPRETA, CONOCE, AMPLIA)
    dimension      EricaDimension
    
    // ‚≠ê Estado (E, B, P, C, N) - reemplaza categoryId + scaleId
    state          EricaState
    
    // ‚≠ê Puntos calculados autom√°ticamente seg√∫n estado
    // E=1.0, B=0.75, P=0.50, C=0.25, N=0.0
    points         Float
    
    // ‚≠ê D√≠a de la semana (1-5)
    dayOfWeek      Int?
    
    notes          String?
    evaluatedAt    DateTime @default(now())

    // Relaciones
    enrollment     Enrollment    @relation("EricaEnrollment", fields: [enrollmentId], references: [id], onDelete: Cascade)
    course         Course        @relation("EricaCourse", fields: [courseId], references: [id])
    bimester       Bimester      @relation("EricaBimester", fields: [bimesterId], references: [id])
    academicWeek   AcademicWeek  @relation("EricaAcademicWeek", fields: [academicWeekId], references: [id])
    topic          EricaTopic    @relation("EvaluationTopic", fields: [topicId], references: [id], onDelete: Cascade)
    teacher        User          @relation("EricaTeacher", fields: [teacherId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // ‚≠ê CAMBIO: Unique por estudiante, semana, dimensi√≥n (cada estudiante tiene UNA evaluaci√≥n por dimensi√≥n por semana)
    @@unique([enrollmentId, academicWeekId, dimension], name: "unique_student_week_dimension")
    @@index([enrollmentId])
    @@index([courseId])
    @@index([dimension])
    @@index([state])
    @@index([academicWeekId])
    @@map("erica_evaluations")
  }

  /**
  * ‚≠ê PROMEDIOS POR DIMENSI√ìN ERICA
  * 
  * Almacena:
  * - Promedio de cada dimensi√≥n (E, R, I, C, A)
  * - Promedio general
  * - Estad√≠sticas de estados (E, B, P, C, N)
  * - Indicador de si est√° actualizado
  */
  model EricaAverage {
    id           Int @id @default(autoincrement())
    enrollmentId Int
    courseId     Int
    bimesterId   Int

    // ‚≠ê Promedios por dimensi√≥n ERICA
    executeAverage    Float? // Promedio de EJECUTA (E)
    retainAverage     Float? // Promedio de RETIENE (R)
    interpretAverage  Float? // Promedio de INTERPRETA (I)
    knowAverage       Float? // Promedio de CONOCE (C)
    applyAverage      Float? // Promedio de AMPL√çA (A)

    // ‚≠ê Promedio general (promedio de los 5 promedios)
    generalAverage    Float?

    // Estad√≠sticas de evaluaciones
    totalEvaluations  Int @default(0)  // Total de evaluaciones registradas
    
    // Conteo por estado (E, B, P, C, N)
    excellentCount    Int @default(0)  // E = Excelente (1 pto)
    goodCount         Int @default(0)  // B = Bien (0.75 ptos)
    regularCount      Int @default(0)  // P = Poco (0.50 ptos)
    poorCount         Int @default(0)  // C = Casi nada (0.25 ptos)
    nothingCount      Int @default(0)  // N = Nada (0 ptos)

    lastCalculated    DateTime @default(now())
    isUpToDate        Boolean  @default(false)

    enrollment        Enrollment @relation("AverageEnrollment", fields: [enrollmentId], references: [id], onDelete: Cascade)
    course            Course     @relation("AverageCourse", fields: [courseId], references: [id])
    bimester          Bimester   @relation("AverageBimester", fields: [bimesterId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([enrollmentId, courseId, bimesterId], name: "unique_student_course_bimester")
    @@index([enrollmentId])
    @@index([isUpToDate])
    @@map("erica_averages")
  }

  /**
  * ‚≠ê CONFIGURACI√ìN DEL SISTEMA ERICA
  * 
  * Almacena configuraciones din√°micas:
  * - Puntajes por estado
  * - Colores por dimensi√≥n
  * - Pesos de c√°lculos
  */
  model EricaConfig {
    id          Int     @id @default(autoincrement())
    configType  String
    configKey   String
    configValue String
    description String?
    isActive    Boolean @default(true)
    category    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([configType, configKey])
    @@map("erica_configs")
  }

  /**
  * ‚≠ê RESULTADOS FINALES DE ERICA
  * 
  * Almacena los resultados finales agregados por estudiante, bimestre y curso
  * Incluye colores para visualizaci√≥n en reportes
  * 
  * Ejemplo:
  * - resultExecute: 0.85 (promedio de EJECUTA)
  * - resultRetain: 0.75
  * - colorExecute: #00AA00
  */
  model EricaCalculatedResult {
    id Int @id @default(autoincrement())

    enrollmentId      Int
    bimesterId        Int
    courseId          Int

    // ‚≠ê Resultados finales por dimensi√≥n (promedios ponderados o por semana)
    resultExecute     Float @default(0.0)  // E = Ejecuta
    resultRetain      Float @default(0.0)  // R = Retiene
    resultInterpret   Float @default(0.0)  // I = Interpreta
    resultKnow        Float @default(0.0)  // C = Conoce
    resultApply       Float @default(0.0)  // A = Ampl√≠a

    // ‚≠ê Colores correspondientes para reportes/gr√°ficos
    colorExecute      String?
    colorRetain       String?
    colorInterpret    String?
    colorKnow         String?
    colorApply        String?

    // Metadata
    totalWeeksEvaluated Int       @default(0)
    calculationDate     DateTime  @default(now())
    sourceWeeks         String?   // JSON con semanas incluidas en el c√°lculo

    enrollment        Enrollment @relation("CalculatedEnrollment", fields: [enrollmentId], references: [id], onDelete: Cascade)
    bimester          Bimester   @relation("CalculatedBimester", fields: [bimesterId], references: [id])
    course            Course     @relation("CalculatedCourse", fields: [courseId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([enrollmentId, bimesterId, courseId])
    @@index([enrollmentId])
    @@index([bimesterId])
    @@map("erica_calculated_results")
  }

  /**
  * ============================================
  * SECCI√ìN 6: ESTRUCTURA ACAD√âMICA
  * ============================================
  */
  model Grade {
    id       Int     @id @default(autoincrement())
    name     String  @unique
    level    String
    order    Int
    isActive Boolean @default(true)

    cycles       GradeCycle[]
    sections     Section[]
    courseGrades CourseGrade[]
    enrollments  Enrollment[]

    @@map("grades")
  }

  model Section {
    id        Int    @id @default(autoincrement())
    name      String
    capacity  Int
    gradeId   Int
    teacherId Int?
    grade     Grade  @relation(fields: [gradeId], references: [id])

    teacher     User?        @relation("SectionToTeacher", fields: [teacherId], references: [id])
    ericaTopics EricaTopic[] @relation("TopicSection")

    courseAssignments CourseAssignment[]
    enrollments       Enrollment[]
    schedules         Schedule[]
    scheduleConfig    ScheduleConfig?

    @@map("sections")
  }

  model GradeCycle {
    id      Int         @id @default(autoincrement())
    cycleId Int
    gradeId Int
    grade   Grade       @relation(fields: [gradeId], references: [id])
    cycle   SchoolCycle @relation(fields: [cycleId], references: [id])

    @@unique([cycleId, gradeId])
    @@map("grade_cycles")
  }

  /**
  * ============================================
  * SECCI√ìN 6: CURSOS
  * ============================================
  */

  model Course {
    id       Int     @id @default(autoincrement())
    code     String  @unique
    name     String
    area     String?
    color    String? @db.VarChar(7)
    isActive Boolean @default(true)

    courseGrades  CourseGrade[]
    assignments   Assignment[]
    studentGrades StudentGrade[]

    ericaEvaluations  EricaEvaluation[]       @relation("EricaCourse")
    ericaAverages     EricaAverage[]          @relation("AverageCourse")
    ericaTopics       EricaTopic[]            @relation("TopicCourse")
    courseAssignments CourseAssignment[]
    calculatedResults EricaCalculatedResult[] @relation("CalculatedCourse")
    schedules         Schedule[]

    attendanceReports StudentAttendanceReport[] @relation("ReportCourse")

    @@map("courses")
  }

  model CourseGrade {
    id       Int     @id @default(autoincrement())
    courseId Int
    gradeId  Int
    isCore   Boolean @default(true)

    course Course @relation(fields: [courseId], references: [id])
    grade  Grade  @relation(fields: [gradeId], references: [id])

    @@unique([courseId, gradeId])
    @@map("course_grades")
  }

  /**
  * ============================================
  * SECCI√ìN 7: ASIGNACI√ìN DE CURSOS
  * ============================================
  */

  /**
  * Tipos de asignaci√≥n de cursos
  */
  enum AssignmentType {
    titular // Maestro titular de la secci√≥n
    apoyo // Maestro de apoyo/especialista
    temporal // Asignaci√≥n temporal
    suplente // Maestro suplente
  }

  model CourseAssignment {
    id             Int            @id @default(autoincrement())
    sectionId      Int
    courseId       Int
    teacherId      Int
    assignmentType AssignmentType @default(titular)
    isActive       Boolean        @default(true)

    assignedAt DateTime @default(now())
    assignedBy Int?
    notes      String?

    section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
    course  Course  @relation(fields: [courseId], references: [id])
    teacher User    @relation("CourseAssignment", fields: [teacherId], references: [id])

    schedules        Schedule[]
    history          CourseAssignmentHistory[] @relation("CourseAssignmentOriginal")
    classAttendances StudentClassAttendance[]

    updatedAt DateTime @updatedAt

    @@unique([sectionId, courseId], name: "unique_section_course")
    @@index([teacherId])
    @@map("course_assignments")
  }

  /**
  * ============================================
  * SECCI√ìN 8: HISTORIAL DE ASIGNACIONES
  * ============================================
  */

  model CourseAssignmentHistory {
    id                 Int       @id @default(autoincrement())
    courseAssignmentId Int
    teacherId          Int
    assignedAt         DateTime  @default(now())
    unassignedAt       DateTime?
    reason             String?
    replacedBy         Int?
    notes              String?
    changedBy          Int?

    courseAssignment CourseAssignment @relation("CourseAssignmentOriginal", fields: [courseAssignmentId], references: [id], onDelete: Cascade)
    teacher          User             @relation("AssignedHistory", fields: [teacherId], references: [id])
    changedByUser    User?            @relation("ChangedBy", fields: [changedBy], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([courseAssignmentId])
    @@index([teacherId])
    @@map("course_assignment_history")
  }

  /**
  * ============================================
  * SECCI√ìN 8.5: HORARIOS
  * ============================================
  */

  model Schedule {
    id                 Int     @id @default(autoincrement())
    sectionId          Int
    courseId           Int
    courseAssignmentId Int
    dayOfWeek          Int
    startTime          String
    endTime            String
    classroom          String?

    teacherId Int?

    substituteTeacherId Int?
    isSubstitution      Boolean   @default(false)
    substitutionReason  String?
    substitutionDate    DateTime?

    absenceId Int?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    section           Section          @relation(fields: [sectionId], references: [id])
    course            Course           @relation(fields: [courseId], references: [id])
    courseAssignment  CourseAssignment @relation(fields: [courseAssignmentId], references: [id], onDelete: Cascade)
    teacher           User?            @relation("TeacherSchedulePrimary", fields: [teacherId], references: [id])
    substituteTeacher User?            @relation("TeacherScheduleSubstitute", fields: [substituteTeacherId], references: [id])
    absence           TeacherAbsence?  @relation(fields: [absenceId], references: [id], onDelete: SetNull)

    attendance       TeacherAttendance[]      @relation("ScheduleAttendance")
    classAttendances StudentClassAttendance[]

    @@unique([courseAssignmentId, dayOfWeek, startTime], name: "unique_schedule_slot")
    @@index([teacherId])
    @@index([substituteTeacherId])
    @@index([dayOfWeek, startTime])
    @@index([absenceId])
    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([teacherId, dayOfWeek], name: "idx_schedules_teacher_day")
    @@map("schedules")
  }

  model ScheduleConfig {
    id            Int      @id @default(autoincrement())
    sectionId     Int      @unique
    workingDays   Json
    startTime     String
    endTime       String
    classDuration Int
    breakSlots    Json
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

    @@map("schedule_configs")
  }

  /**
  * ============================================
  * SECCI√ìN 9: AUSENCIAS Y PERMISOS DE MAESTROS
  * ============================================
  */

  model TeacherAbsence {
    id        Int      @id @default(autoincrement())
    teacherId Int
    startDate DateTime
    endDate   DateTime
    reason    String

    substituteTeacherId Int?

    status     String    @default("pending")
    approvedBy Int?
    approvedAt DateTime?

    notes         String?
    attachmentUrl String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    teacher        User       @relation("TeacherAbsence", fields: [teacherId], references: [id], onDelete: Cascade)
    approvedByUser User?      @relation("ApprovedBy", fields: [approvedBy], references: [id])
    schedules      Schedule[]

    @@index([teacherId])
    @@index([status])
    @@index([startDate, endDate])
    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([teacherId, startDate, endDate, status], name: "idx_teacher_absences_date_range")
    @@map("teacher_absences")
  }

  model TeacherLeaveRequest {
    id        Int      @id @default(autoincrement())
    teacherId Int
    startDate DateTime
    endDate   DateTime
    reason    String

    substituteTeacherId Int?

    status          String    @default("pending")
    approvedBy      Int?
    approvedAt      DateTime?
    rejectionReason String?

    notes     String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    teacher        User  @relation("TeacherLeaveRequest", fields: [teacherId], references: [id], onDelete: Cascade)
    approvedByUser User? @relation("ApprovedLeaveBy", fields: [approvedBy], references: [id])

    @@index([teacherId])
    @@index([status])
    @@map("teacher_leave_requests")
  }

  model TeacherAttendance {
    id         Int      @id @default(autoincrement())
    teacherId  Int
    scheduleId Int
    date       DateTime
    status     String
    notes      String?

    recordedAt DateTime @default(now())
    recordedBy Int?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    teacher  User     @relation("TeacherAttendanceRecord", fields: [teacherId], references: [id], onDelete: Cascade)
    schedule Schedule @relation("ScheduleAttendance", fields: [scheduleId], references: [id], onDelete: Cascade)

    @@unique([scheduleId, date], name: "unique_schedule_attendance")
    @@index([teacherId])
    @@index([date])
    @@index([status])
    @@map("teacher_attendances")
  }

  /**
  * ============================================
  * SECCI√ìN 9: SISTEMA DE ASISTENCIA DE ESTUDIANTES
  * ============================================
  */

  model AttendanceStatus {
    id          Int     @id @default(autoincrement())
    code        String  @unique
    name        String
    description String?

    isNegative  Boolean @default(false)
    isExcused   Boolean @default(false)
    isTemporal  Boolean @default(false)

    colorCode String? @db.VarChar(7)
    order     Int     @default(0)

    isActive Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    rolePermissions       RoleAttendancePermission[]
    configMappings        ConfigStatusMapping[]         @relation("ConfigStatusMapping")
    currentClassAttendances StudentClassAttendance[]   @relation("CurrentStatus")
    originalClassAttendances StudentClassAttendance[]  @relation("OriginalStatus")

    @@index([code])
    @@map("attendance_statuses")
  }

  /**
  * Tabla intermedia para relacionar AttendanceConfig con AttendanceStatus
  * Maneja qu√© c√≥digos son negativos y cu√°les requieren notas
  */
  model ConfigStatusMapping {
    id          Int    @id @default(autoincrement())
    configId    Int
    statusId    Int
    mappingType String // "negative" | "notesRequired"

    config AttendanceConfig @relation("ConfigNegativeStatuses", fields: [configId], references: [id], onDelete: Cascade)
    status AttendanceStatus @relation("ConfigStatusMapping", fields: [statusId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@unique([configId, statusId, mappingType])
    @@index([configId])
    @@index([statusId])
    @@map("config_status_mappings")
  }

  model RoleAttendancePermission {
    id                 Int @id @default(autoincrement())
    roleId             Int
    attendanceStatusId Int

    canView             Boolean @default(true)
    canCreate           Boolean @default(false)
    canModify           Boolean @default(false)
    canDelete           Boolean @default(false)
    canApprove          Boolean @default(false)
    canAddJustification Boolean @default(false)
    justificationRequired Boolean @default(false)

    requiresNotes  Boolean @default(false)
    minNotesLength Int?
    maxNotesLength Int?

    notes String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    role             Role             @relation("RoleAttendancePermissions", fields: [roleId], references: [id], onDelete: Cascade)
    attendanceStatus AttendanceStatus @relation(fields: [attendanceStatusId], references: [id], onDelete: Cascade)

    @@unique([roleId, attendanceStatusId])
    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([roleId, attendanceStatusId], name: "idx_role_attendance_perms")
    @@map("role_attendance_permissions")
  }

  model AttendanceConfig {
    id Int @id @default(autoincrement())

    name        String  @unique
    description String?

    riskThresholdPercentage Float @default(80.0)
    consecutiveAbsenceAlert Int   @default(3)

    defaultNotesPlaceholder String?

    lateThresholdTime       String @default("08:30")
    markAsTardyAfterMinutes Int    @default(15)

    justificationRequiredAfter Int @default(3)
    maxJustificationDays       Int @default(365)

    autoApproveJustification Boolean @default(false)
    autoApprovalAfterDays    Int     @default(7)

    isActive Boolean @default(true)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    statusMappings ConfigStatusMapping[] @relation("ConfigNegativeStatuses")

    @@map("attendance_configs")
  }



  model StudentClassAttendance {
    id                 Int       @id @default(autoincrement())
    
    // üîë Identificadores principales
    enrollmentId       Int
    date               DateTime
    
    // Ya exist√≠an
    scheduleId         Int
    courseAssignmentId Int
    attendanceStatusId Int

    // Informaci√≥n de asistencia
    status        String    // C√≥digo actual: "PRESENT", "ABSENT", "TARDY"
    arrivalTime   String?
    departureTime String?   // Hora de salida temprana
    minutesLate   Int?      // Minutos de retardo calculado
    isEarlyExit   Boolean @default(false)  // Salida temprana registrada
    exitReason    String?   // Raz√≥n de salida temprana
    notes         String?

    // Registro inicial
    recordedBy Int?
    recordedAt DateTime @default(now())

    // üîë NUEVO: Estado original (NUNCA cambia)
    originalAttendanceStatusId Int?
    originalStatus             String?

    // Auditor√≠a integrada
    lastModifiedBy     Int?
    lastModifiedAt     DateTime?
    modificationReason String?

    // üîë NUEVO: Agrupa registros del mismo "registro inicial"
    recordingGroupId    String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // ‚úÖ Relaciones actualizadas
    enrollment        Enrollment        @relation("ClassAttendanceEnrollment", fields: [enrollmentId], references: [id], onDelete: Cascade)
    schedule          Schedule          @relation(fields: [scheduleId], references: [id])
    courseAssignment  CourseAssignment  @relation(fields: [courseAssignmentId], references: [id])
    
    // üîë Status actual
    attendanceStatus    AttendanceStatus  @relation("CurrentStatus", fields: [attendanceStatusId], references: [id])
    
    // üîë Status original (para auditor√≠a)
    originalAttendanceStatus AttendanceStatus? @relation("OriginalStatus", fields: [originalAttendanceStatusId], references: [id])
    
    recordedByUser    User?             @relation("RecordedByClassAttendance", fields: [recordedBy], references: [id])
    modifiedByUser    User?             @relation("ModifiedByClassAttendance", fields: [lastModifiedBy], references: [id])
    
    justification     StudentJustification? @relation("ClassAttendanceJustification")

    // ‚úÖ √çndices actualizados
    @@unique([enrollmentId, scheduleId, date], name: "unique_class_attendance")
    @@index([enrollmentId])
    @@index([scheduleId])
    @@index([date])
    @@index([courseAssignmentId])
    @@index([attendanceStatusId])
    @@index([originalAttendanceStatusId])
    @@index([recordingGroupId])
    @@index([lastModifiedBy])
    @@index([enrollmentId, date], name: "idx_student_class_attendance_enrollment_date")
    @@map("student_class_attendances")
  }

  model StudentJustification {
    id                 Int @id @default(autoincrement())
    classAttendanceId  Int @unique
    enrollmentId       Int

    startDate DateTime
    endDate   DateTime

    type        String
    reason      String
    description String?

    documentUrl  String?
    documentType String?
    documentName String?

    status          String    @default("pending")
    approvedBy      Int?
    approvedAt      DateTime?
    rejectionReason String?

    needsFollowUp Boolean @default(false)
    followUpNotes String?

    submittedBy Int
    submittedAt DateTime @default(now())

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    classAttendance StudentClassAttendance @relation("ClassAttendanceJustification", fields: [classAttendanceId], references: [id], onDelete: Cascade)
    enrollment      Enrollment            @relation("JustificationEnrollment", fields: [enrollmentId], references: [id], onDelete: Cascade)
    approvedByUser  User?                 @relation("JustificationApprovedBy", fields: [approvedBy], references: [id])
    submittedByUser User                  @relation("JustificationSubmittedBy", fields: [submittedBy], references: [id])

    @@index([classAttendanceId])
    @@index([enrollmentId])
    @@index([status])
    @@index([startDate, endDate])
    @@map("student_justifications")
  }



  model StudentAttendanceReport {
    id           Int  @id @default(autoincrement())
    enrollmentId Int  @unique // ‚úÖ MANTENER @unique
    bimesterId   Int
    courseId     Int?

    countPresent           Int @default(0)
    countAbsent            Int @default(0)
    countAbsentJustified   Int @default(0)
    countTemporal          Int @default(0)
    countTemporalJustified Int @default(0)

    totalSchoolDays Int @default(0)
    totalMarkDays   Int @default(0)

    attendancePercentage Float @default(100.0)
    absencePercentage    Float @default(0.0)

    consecutiveAbsences Int     @default(0)
    isAtRisk            Boolean @default(false)
    needsIntervention   Boolean @default(false)

    notes String?

    calculatedAt       DateTime @default(now())
    lastRecalculatedAt DateTime @updatedAt
    
    // üîë NUEVO: Snapshot de c√°lculo para auditor√≠a
    calculationSnapshot String? // JSON con detalles de c√°lculo

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    enrollment Enrollment @relation("ReportEnrollment", fields: [enrollmentId], references: [id], onDelete: Cascade)
    bimester   Bimester   @relation("ReportBimester", fields: [bimesterId], references: [id])
    course     Course?    @relation("ReportCourse", fields: [courseId], references: [id])

    @@unique([enrollmentId, bimesterId, courseId], name: "unique_attendance_report")
    @@index([enrollmentId])
    @@index([isAtRisk])
    @@map("student_attendance_reports")
  }

  /**
  * ============================================
  * SECCI√ìN 10: MATR√çCULAS Y EVALUACIONES
  * ============================================
  */

  model Enrollment {
    id           Int  @id @default(autoincrement())
    studentId    Int
    cycleId      Int
    gradeId      Int
    sectionId    Int
    createdById  Int?
    modifiedById Int?

    status             EnrollmentStatus @default(ACTIVE)
    dateEnrolled       DateTime         @default(now())
    statusChangeReason String?
    notes              String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relaciones principales
    student Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
    cycle   SchoolCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
    grade   Grade       @relation(fields: [gradeId], references: [id], onDelete: Restrict)
    section Section     @relation(fields: [sectionId], references: [id], onDelete: Cascade)

    // Relaciones de auditor√≠a
    createdBy  User? @relation("EnrollmentsCreated", fields: [createdById], references: [id], onDelete: SetNull)
    modifiedBy User? @relation("EnrollmentsModified", fields: [modifiedById], references: [id], onDelete: SetNull)

    // Relaciones inversas
    ericaEvaluations   EricaEvaluation[]        @relation("EricaEnrollment")
    ericaAverages      EricaAverage[]           @relation("AverageEnrollment")
    calculatedResults  EricaCalculatedResult[]  @relation("CalculatedEnrollment")
    grades             StudentGrade[]
    classAttendances   StudentClassAttendance[] @relation("ClassAttendanceEnrollment")
    justifications     StudentJustification[]   @relation("JustificationEnrollment")
    attendanceReport   StudentAttendanceReport? @relation("ReportEnrollment")

    // Constraints
    @@unique([studentId, cycleId], name: "unique_student_cycle")
    @@index([studentId])
    @@index([cycleId])
    @@index([status])
    @@index([dateEnrolled])
    // ‚≠ê √çNDICES PARA ASISTENCIA
    @@index([sectionId, cycleId, status], name: "idx_enrollments_section_cycle_status")
    @@map("enrollments")
  }

  model StudentGrade {
    id           Int     @id @default(autoincrement())
    enrollmentId Int
    courseId     Int
    bimesterId   Int
    value        Float
    comments     String?

    enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
    course     Course     @relation(fields: [courseId], references: [id])
    bimester   Bimester   @relation(fields: [bimesterId], references: [id])

    @@unique([enrollmentId, courseId, bimesterId])
    @@map("student_grades")
  }

  /**
  * model Attendance {
  * id           Int      @id @default(autoincrement())
  * enrollmentId Int
  * bimesterId   Int
  * date         DateTime
  * status       String
  * notes        String?
  * enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  * bimester   Bimester   @relation(fields: [bimesterId], references: [id])
  * @@map("attendances")
  * }
  */
  /**
  * ============================================
  * SECCI√ìN 10: TAREAS Y EVALUACIONES
  * ============================================
  */

  model Assignment {
    id         Int      @id @default(autoincrement())
    courseId   Int
    bimesterId Int
    title      String
    dueDate    DateTime
    maxScore   Float

    course      Course                 @relation(fields: [courseId], references: [id])
    bimester    Bimester               @relation(fields: [bimesterId], references: [id])
    submissions AssignmentSubmission[]

    @@map("assignments")
  }

  model AssignmentSubmission {
    id           Int       @id @default(autoincrement())
    assignmentId Int
    studentId    Int
    teacherId    Int?
    score        Float?
    feedback     String?
    submittedAt  DateTime? @default(now())

    assignment Assignment @relation(fields: [assignmentId], references: [id])
    student    Student    @relation("SubmissionStudent", fields: [studentId], references: [id])
    teacher    User?      @relation("SubmissionGrader", fields: [teacherId], references: [id])

    @@map("assignment_submissions")
  }

  /**
  * ============================================
  * SECCI√ìN 7: FIRMAS PARA CARTAS DE NOTAS
  * ============================================
  */

  /**
  * Tipos de firmas para cartas de notas
  * Define qui√©n firma (docente, director, coordinador, etc)
  */
  enum SignatureType {
    TEACHER // Docente/Maestro de curso
    DIRECTOR // Director/Directora de escuela
    COORDINATOR // Coordinador acad√©mico
    PRINCIPAL // Principal√≠a
    CUSTOM // Otros firmantes personalizados
  }

  /**
  * Modelo para gestionar firmas digitales en cartas de notas
  * 
  * Permite:
  * - Firma del docente (obtenida de User + rol TEACHER)
  * - Firma del director (obtenida de User + rol DIRECTOR u otro designado)
  * - M√∫ltiples firmas por ciclo escolar
  * - Flexibilidad para diferentes ciclos/grados
  */
  model Signature {
    id          Int           @id @default(autoincrement())
    type        SignatureType // Tipo de firmante (docente, director, etc)
    
    // Usuario que firma
    userId      Int
    user        User          @relation("UserSignatures", fields: [userId], references: [id], onDelete: Cascade)
    
    // Para director: especificar el ciclo escolar o deixar NULL para todos
    schoolCycleId Int?
    schoolCycle SchoolCycle? @relation("SignaturesCycle", fields: [schoolCycleId], references: [id], onDelete: SetNull)
    
    // URL de la firma (imagen/PDF de Cloudinary)
    signatureUrl  String?
    publicId      String? // ID de Cloudinary para poder eliminar despu√©s
    
    // Metadatos
    signatureName String? // Nombre legible de qui√©n firma (para cuando no coincida con User.fullName)
    title         String? // T√≠tulo del firmante (Ej: "Directora General", "Coordinadora Acad√©mica")
    
    // Estado
    isActive      Boolean @default(true)
    isDefault     Boolean @default(false) // Si es la firma por defecto para ese tipo
    
    // Validez
    validFrom     DateTime? // Desde cu√°ndo es v√°lida la firma
    validUntil    DateTime? // Hasta cu√°ndo es v√°lida la firma
    
    // Auditor√≠a
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // √çndices
    @@unique([userId, type, schoolCycleId], name: "unique_user_signature_type_cycle")
    @@index([type])
    @@index([userId])
    @@index([schoolCycleId])
    @@index([isActive, isDefault])
    @@map("signatures")
  }




