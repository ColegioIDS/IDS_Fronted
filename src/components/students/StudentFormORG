import { useEffect } from "react";
import { useForm, useFieldArray, useWatch } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { format } from "date-fns";
import { es } from 'date-fns/locale';

// Esquemas e interfaces
import { StudentSchema, StudentFormValues } from "@/schemas/Students";

// Componentes UI
import { Separator } from '@/components/ui/separator';
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { Calendar } from "@/components/ui/calendar";
import { Checkbox } from "@/components/ui/checkbox";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

// Iconos
import { CiCalendarDate as CalendarIcon } from "react-icons/ci";
import { FaUserEdit } from "react-icons/fa";
import { FaRegTrashAlt } from "react-icons/fa";
import { Divide } from "lucide-react";

type UserFormProps = {
  isEditMode?: boolean;
  userId?: number;
};

export function StudentForm({ isEditMode = false, userId }: UserFormProps) {
  // Valores por defecto
  const defaultValues: StudentFormValues = {
    givenNames: "",
    lastNames: "",
    birthDate: new Date(new Date().getFullYear() - 5, 0, 1),
    siblingsCount: 0,
    brothersCount: 0,
    sistersCount: 0,
    enrollmentStatus: "active",
    medicalInfo: {
      hasDisease: false,
      takesMedication: false,
      hasAllergies: false,
      emergencyMedicationAllowed: true,
      hasLearningDisability: false,
      diseaseDetails: null,
      medicationDetails: null,
      allergiesDetails: null,
      disabilityDetails: null,
      strengths: null,
      areasToImprove: null,
    },
    academicRecords: [],
    codeSIRE: null,
    birthPlace: null,
    nationality: null,
    gender: undefined,
    favoriteColor: null,
    hobby: null,
    favoriteFood: null,
    favoriteSubject: null,

    parents: [
      {
        userId: null,
        newParent: {
          givenNames: "",
          lastNames: "",
          dpi: "",
          phone: "",
          birthDate: null,
          gender: undefined,
          email: null,
          details: {
            dpiIssuedAt: "",
            occupation: "",
            workplace: "",
            email: null,
            workPhone: null,
          },
        },
        relationshipType: "Padre",
        isPrimaryContact: true,
        hasLegalCustody: true,
        financialResponsible: false,
        livesWithStudent: true,
        emergencyContactPriority: 1,
      }
    ],
    emergencyContacts: [
      {
        name: "",
        relationship: "",
        phone: null,
      }
    ],
    address: {
      street: "",
      zone: "",
      municipality: "",
      department: "",
    },
    authorizedPersons: [
      {
        name: "",
        relationship: "",
        phone: null,
      }
    ],
    siblings: [
      {
        name: "",
        age: 0,
        gender: null,
      }
    ],
    busService: {
      hasService: false,
      pickupPersonName: null,
      dropoffPersonName: null,
      homeAddress: null,
      referencePoints: null,
      emergencyContact: null,
      emergencyDeliveryPerson: null,
      route: null,
      monthlyFee: null,
      acceptedRules: false,
      signedDate: null,
    },
  };

  // Formulario y field arrays
  const form = useForm({
    resolver: zodResolver(StudentSchema),
    defaultValues,
  });

  const { fields, append, remove } = useFieldArray({
    control: form.control,
    name: 'parents',
  });

  const {
    fields: authorizedFields,
    append: appendAuthorized,
    remove: removeAuthorized,
  } = useFieldArray({
    control: form.control,
    name: "authorizedPersons",
  });

  const {
    fields: siblingFields,
    append: appendSibling,
    remove: removeSibling,
  } = useFieldArray({
    control: form.control,
    name: "siblings",
  });

  // Watchers
  const siblingsCount = useWatch({
    control: form.control,
    name: "siblingsCount",
  });

  // Efectos
  useEffect(() => {
    const count = Number(siblingsCount ?? 0);
    const currentLength = siblingFields.length;

    if (count > currentLength) {
      for (let i = currentLength; i < count; i++) {
        appendSibling({ name: "", age: 0, gender: "" });
      }
    } else if (count < currentLength) {
      for (let i = currentLength - 1; i >= count; i--) {
        removeSibling(i);
      }
    }
  }, [siblingsCount, siblingFields.length]);

  // Handlers
  const onSubmit = (data: z.infer<typeof StudentSchema>) => {
    console.log(data);
  };

  // Renderizado del formulario iría aquí...

    return (

        <Card className=
            "rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]"
        >
            <CardHeader>
                <CardTitle className="text-2xl font-bold flex items-center gap-2">
                    <FaUserEdit />
                    {isEditMode ? 'Editar Usuario' : 'Registro de Estudiante'}

                </CardTitle>
            </CardHeader>

            <CardContent>

                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">

                        {/* Sección DATOS PERSONALES DEL ALUMNO */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <h2 className="text-xl font-bold col-span-full">Datos Personales del Alumno</h2>

                            <FormField
                                control={form.control}
                                name="givenNames"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Nombres</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Juan Carlos" {...field} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="lastNames"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Apellidos</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Pérez García" {...field} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="birthDate"
                                render={({ field }) => (
                                    <FormItem className="flex flex-col">
                                        <FormLabel>Fecha de Nacimiento</FormLabel>
                                        <Popover>
                                            <PopoverTrigger asChild>
                                                <FormControl>
                                                    <Button
                                                        variant={"outline"}
                                                        className="pl-3 text-left font-normal text-black dark:text-white"

                                                    >
                                                        {field.value ? (
                                                            format(field.value, "PPP", { locale: es })
                                                        ) : (
                                                            <span>Selecciona una fecha</span>
                                                        )}
                                                        <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                                                    </Button>
                                                </FormControl>
                                            </PopoverTrigger>
                                            <PopoverContent className="w-auto p-0 bg-white dark:bg-gray-900 text-black dark:text-white" align="start">

                                                <Calendar
                                                    mode="single"
                                                    selected={field.value}
                                                    onSelect={field.onChange}
                                                    disabled={(date) =>
                                                        date > new Date() || date < new Date("1900-01-01")
                                                    }
                                                    initialFocus
                                                    captionLayout="dropdown"
                                                    fromYear={1900}
                                                    toYear={new Date().getFullYear()}
                                                    locale={es}
                                                />
                                            </PopoverContent>
                                        </Popover>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="birthPlace"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Lugar de Nacimiento</FormLabel>
                                        <FormControl>
                                            <Input placeholder="El Tejar Chimaltenango"
                                                {...field}
                                                value={field.value || ""}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />


                            <FormField
                                control={form.control}
                                name="nationality"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Nacionalidad</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Guatemalteco/a"
                                                {...field}
                                                value={field.value || ""}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />


                            <FormField
                                control={form.control}
                                name="address.street"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Calle y Número</FormLabel>
                                        <FormControl>
                                            <Input

                                                placeholder="Av. Siempre Viva 123"
                                                {...field}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="address.zone"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Zona</FormLabel>
                                        <FormControl>
                                            <Input
                                                className="dark:bg-gray-900/50 dark:border-gray-700"
                                                placeholder="Zona 15"
                                                {...field}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="address.municipality"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Municipio</FormLabel>
                                        <FormControl>
                                            <Input
                                                className="dark:bg-gray-900/50 dark:border-gray-700"
                                                placeholder="Villa Nueva"
                                                {...field}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="address.department"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Departamento</FormLabel>
                                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                                            <FormControl>
                                                <SelectTrigger className="dark:bg-gray-900/50 dark:border-gray-700 w-full">
                                                    <SelectValue placeholder="Selecciona un departamento" />
                                                </SelectTrigger>
                                            </FormControl>
                                            <SelectContent className="dark:bg-gray-800 dark:border-gray-700">
                                                <SelectItem value="Guatemala">Guatemala</SelectItem>
                                                <SelectItem value="Chimaltenango">Chimaltenango</SelectItem>
                                                {/* Agrega más departamentos según necesites */}
                                            </SelectContent>
                                        </Select>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />


                            <FormField
                                control={form.control}
                                name="financialResponsibleText"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>¿Quien sostendra los estudios?</FormLabel>
                                        <FormControl>
                                            <Input
                                                className="dark:bg-gray-900/50 dark:border-gray-700"
                                                placeholder="Nombre del responsable"
                                                {...field}
                                                value={field.value || ""}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="livesWithText"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>¿Con quien vive?</FormLabel>
                                        <FormControl>
                                            <Input
                                                className="dark:bg-gray-900/50 dark:border-gray-700"
                                                placeholder="Con madre, padre, abuelos, etc."
                                                {...field}
                                                value={field.value || ""}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />









                            <FormField
                                control={form.control}
                                name="gender"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Género</FormLabel>
                                        <Select onValueChange={field.onChange} defaultValue={field.value}>
                                            <FormControl>
                                                <SelectTrigger className="w-full">
                                                    <SelectValue placeholder="Selecciona un género" />
                                                </SelectTrigger>
                                            </FormControl>
                                            <SelectContent>
                                                <SelectItem value="Masculino">Masculino</SelectItem>
                                                <SelectItem value="Femenino">Femenino</SelectItem>
                                                <SelectItem value="Otro">Otro</SelectItem>
                                            </SelectContent>
                                        </Select>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />


                        </div>


                        {/* Seccion de  Padres o encargados */}
                        <Separator className="my-6 dark:bg-gray-700" />

                        <div className="space-y-6">
                            <h2 className="text-xl font-bold">Datos de Padres o Encargados</h2>

                            {fields.map((field, index) => (
                                <div key={field.id} className="relative p-4 space-y-4">
                                    {/* Botón eliminar en la esquina superior derecha */}
                                    <button
                                        type="button"
                                        onClick={() => remove(index)}
                                        className="absolute top-2 right-2 text-sm text-red-600 hover:text-red-800 font-medium"
                                    >
                                        <FaRegTrashAlt />
                                    </button>

                                    <div className="flex items-center justify-between">


                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.relationshipType`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Relación</FormLabel>
                                                    <Select onValueChange={field.onChange} value={field.value}>
                                                        <FormControl>
                                                            <SelectTrigger>
                                                                <SelectValue placeholder="Selecciona la relación" />
                                                            </SelectTrigger>
                                                        </FormControl>
                                                        <SelectContent>
                                                            <SelectItem value="Padre">Padre</SelectItem>
                                                            <SelectItem value="Madre">Madre</SelectItem>
                                                            <SelectItem value="Tutor">Tutor</SelectItem>
                                                            <SelectItem value="Otro">Otro</SelectItem>
                                                        </SelectContent>
                                                    </Select>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />

                                    </div>


                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.givenNames`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Nombres</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Juan Carlos" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />

                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.lastNames`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Apellidos</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Pérez García" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">

                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.dpi`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>DPI</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="1234567890123" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />
                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.details.dpiIssuedAt`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Extendido en</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Guatemala" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />

                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.phone`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Teléfono</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Teléfono" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">

                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.email`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Correo Electrónico</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Correo Electrónico" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />


                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.details.occupation`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Profesion/Ocupacion</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Profesion/Ocupacion" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />

                                        <FormField
                                            control={form.control}
                                            name={`parents.${index}.newParent.details.workplace`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Lugar de Trabajo</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Lugar de Trabajo" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />



                                    </div>
                                </div>
                            ))}

                            <div>
                                <button
                                    type="button"
                                    onClick={() =>
                                        append({
                                            relationshipType: 'Padre',
                                            newParent: {
                                                givenNames: '',
                                                lastNames: '',
                                                dpi: '',
                                                birthDate: new Date(),
                                                gender: 'Masculino',
                                                phone: '',
                                                email: null,
                                                details: {
                                                    dpiIssuedAt: '',
                                                    occupation: '',
                                                    workplace: '',
                                                    workPhone: null,
                                                },
                                            },
                                        })
                                    }
                                    className="px-4 py-2 text-sm font-semibold bg-primary text-white rounded-lg hover:bg-primary/90 transition"
                                >
                                    + Agregar padre o encargado
                                </button>
                            </div>
                        </div>



                        {/* Seccion de Emergencia */}
                        <Separator className="my-6 dark:bg-gray-700" />
                        <div className="space-y-6 ">
                            <h2 className="text-xl font-bold">Información de Emergencia</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <FormField
                                    control={form.control}
                                    name="emergencyContacts.0.name"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Nombres</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Nombre del contacto" {...field} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                                <FormField
                                    control={form.control}
                                    name="emergencyContacts.0.phone"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Teléfono de Emergencia</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Teléfono" {...field} value={field.value || ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                                <FormField
                                    control={form.control}
                                    name="emergencyContacts.0.relationship"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Parentesco</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Parentesco" {...field} value={field.value || ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>
                        </div>

                        {/* Seccion de datos academicos */}
                        <Separator className="my-6 dark:bg-gray-700" />
                        <div className="space-y-6">
                            <h2 className="text-xl font-bold">Datos Académicos</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">


                                <FormField
                                    control={form.control}
                                    name="academicRecords.0.schoolName"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Nombre de la Escuela</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Nombre de la Escuela" {...field} value={field.value || ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="academicRecords.0.gradeCompleted"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Grado Completado</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Grado Completado" {...field} value={field.value || ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="currentGrade"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Grado Actual</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Grado Actual" {...field} value={field.value || ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                            </div>
                        </div>



                        {/* Sección Información Médica */}
                        <Separator className="my-6 dark:bg-gray-700" />
                        <div className="space-y-6">
                            <h2 className="text-xl font-bold">Información Médica</h2>

                            <FormField
                                control={form.control}
                                name="medicalInfo.hasDisease"
                                render={({ field }) => (
                                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                                        <FormControl>
                                            <Checkbox
                                                checked={field.value}
                                                onCheckedChange={field.onChange}
                                            />
                                        </FormControl>
                                        <div className="space-y-1 leading-none">
                                            <FormLabel>¿Tiene alguna enfermedad?</FormLabel>
                                            <FormDescription>
                                                Marque si el estudiante padece alguna enfermedad crónica o condición médica
                                            </FormDescription>
                                        </div>
                                    </FormItem>
                                )}
                            />

                            {form.watch("medicalInfo.hasDisease") && (
                                <FormField
                                    control={form.control}
                                    name="medicalInfo.diseaseDetails"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Detalles de la enfermedad</FormLabel>
                                            <FormControl>
                                                <Textarea
                                                    placeholder="Describa la enfermedad o condición médica y que medicación requiere."
                                                    className="resize-none"
                                                    {...field}
                                                    value={field.value || ""}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            )}

                            <FormField
                                control={form.control}
                                name="medicalInfo.hasAllergies"
                                render={({ field }) => (
                                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                                        <FormControl>
                                            <Checkbox
                                                checked={field.value}
                                                onCheckedChange={field.onChange}
                                            />
                                        </FormControl>
                                        <div className="space-y-1 leading-none">
                                            <FormLabel>¿Tiene alergias?</FormLabel>
                                            <FormDescription>
                                                Marque si el estudiante tiene alergias conocidas
                                            </FormDescription>
                                        </div>
                                    </FormItem>
                                )}
                            />

                            {form.watch("medicalInfo.hasAllergies") && (
                                <FormField
                                    control={form.control}
                                    name="medicalInfo.allergiesDetails"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Detalles de alergias</FormLabel>
                                            <FormControl>
                                                <Textarea
                                                    placeholder="Describa las alergias. "
                                                    className="resize-none"
                                                    {...field}
                                                    value={field.value || ""}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            )}



                            <FormField
                                control={form.control}
                                name="medicalInfo.takesMedication"
                                render={({ field }) => (
                                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                                        <FormControl>
                                            <Checkbox
                                                checked={field.value}
                                                onCheckedChange={field.onChange}
                                            />
                                        </FormControl>
                                        <div className="space-y-1 leading-none">
                                            <FormLabel>En caso de emergencia autoriza darle algun medicamento.</FormLabel>
                                            <FormDescription>
                                                Marque si se autoriza administrar algún medicamento en caso de emergencia
                                            </FormDescription>
                                        </div>
                                    </FormItem>
                                )}
                            />
                            {form.watch("medicalInfo.takesMedication") && (
                                <FormField
                                    control={form.control}
                                    name="medicalInfo.medicationDetails"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Detalles de la medicación</FormLabel>
                                            <FormControl>
                                                <Textarea
                                                    placeholder="Describa la medicación que toma y su frecuencia."
                                                    className="resize-none"
                                                    {...field}
                                                    value={field.value || ""}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            )}


                            <FormField
                                control={form.control}
                                name="medicalInfo.hasLearningDisability"
                                render={({ field }) => (
                                    <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                                        <FormControl>
                                            <Checkbox
                                                checked={field.value}
                                                onCheckedChange={field.onChange}
                                            />
                                        </FormControl>
                                        <div className="space-y-1 leading-none">
                                            <FormLabel>¿Tiene alguna discapacidad de aprendizaje?</FormLabel>
                                            <FormDescription>
                                                Marque si el estudiante tiene alguna discapacidad de aprendizaje.
                                            </FormDescription>
                                        </div>
                                    </FormItem>
                                )}
                            />
                            {form.watch("medicalInfo.hasLearningDisability") && (
                                <FormField
                                    control={form.control}
                                    name="medicalInfo.disabilityDetails"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Diagnóstico de la discapacidad</FormLabel>
                                            <FormControl>
                                                <Textarea
                                                    placeholder="Describa el diagnóstico médico o profesional relacionado con la discapacidad de aprendizaje."
                                                    className="resize-none"
                                                    {...field}
                                                    value={field.value || undefined}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            )}

                            <FormField
                                control={form.control}
                                name="medicalInfo.strengths"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Fortalezas</FormLabel>
                                        <FormControl>
                                            <Textarea
                                                placeholder="Describa las fortalezas del estudiante."
                                                className="resize-none"
                                                {...field}
                                                value={field.value || ''}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />
                            <FormField
                                control={form.control}
                                name="medicalInfo.areasToImprove"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Áreas a Mejorar</FormLabel>
                                        <FormControl>
                                            <Textarea
                                                placeholder="Describa las áreas en las que el estudiante necesita mejorar."
                                                className="resize-none"
                                                {...field}
                                                value={field.value || ''}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />


                        </div>

                        {/* Contactos de emergencia */}
                        <Separator className="my-6 dark:bg-gray-700" />
                        <div className="space-y-6">
                            <h2 className="text-xl font-bold">Personas autorizadas para retirar al estudiante</h2>

                            {authorizedFields.map((field, index) => (
                                <div key={field.id} className="relative p-4 space-y-4">
                                    {/* Botón eliminar */}
                                    <button
                                        type="button"
                                        onClick={() => removeAuthorized(index)}
                                        className="absolute top-2 right-2 text-sm text-red-600 hover:text-red-800 font-medium"
                                    >
                                        <FaRegTrashAlt />
                                    </button>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <FormField
                                            control={form.control}
                                            name={`authorizedPersons.${index}.name`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Nombre</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Nombre completo" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />

                                        <FormField
                                            control={form.control}
                                            name={`authorizedPersons.${index}.relationship`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Relación</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Relación con el estudiante" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />

                                        <FormField
                                            control={form.control}
                                            name={`authorizedPersons.${index}.phone`}
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Teléfono</FormLabel>
                                                    <FormControl>
                                                        <Input placeholder="Ej. 12345678" {...field} value={field.value ?? ''} />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />
                                    </div>
                                </div>
                            ))}

                            {/* Botón para agregar nuevo contacto autorizado */}
                            <div>
                                <button
                                    type="button"
                                    onClick={() =>
                                        appendAuthorized({
                                            name: "",
                                            relationship: "",
                                            phone: null,
                                        })
                                    }
                                    className="px-4 py-2 text-sm font-semibold bg-primary text-white rounded-lg hover:bg-primary/90 transition"
                                >
                                    + Agregar persona autorizada
                                </button>
                            </div>
                        </div>


                        {/* Patrocinios */}
                        <Separator className="my-6 dark:bg-gray-700" />
                        <div className="space-y-6">
                            <h3 className="text-xl font-bold">Preferencias para Patrocinios</h3>
                            <p className="text-sm">
                                Información sobre gustos del estudiante (para posibles regalos o apoyos)
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

                                <FormField
                                    control={form.control}
                                    name="favoriteColor"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Color Favorito</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Ej. Azul" {...field} value={field.value ?? ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="hobby"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Pasatiempo favorito:</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Ej. Fútbol" {...field} value={field.value ?? ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />


                                <FormField
                                    control={form.control}
                                    name="favoriteToy"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Juguete Favorito</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Ej. Lego" {...field} value={field.value ?? ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="favoriteFood"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Comida Favorita</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Ej. Pizza" {...field} value={field.value ?? ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="favoriteCake"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Pastel Favorito</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Ej. Chocolate" {...field} value={field.value ?? ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />



                                <FormField
                                    control={form.control}
                                    name="favoriteSubject"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Materia Favorita</FormLabel>
                                            <FormControl>
                                                <Input placeholder="Ej. Matemáticas" {...field} value={field.value ?? ''} />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />




                            </div>


                        </div>

                        {/* Sección Hermanos */}
                        <Separator className="my-6 dark:bg-gray-700" />
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <h2 className="text-xl font-bold col-span-full">Hermanos</h2>



                            <FormField
                                control={form.control}
                                name="brothersCount"
                                render={({ field }) => {
                                    const value = typeof field.value === 'number' ? field.value : 0;
                                    return (
                                        <FormItem>
                                            <FormLabel>Hermanos Varones</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    min="0"
                                                    {...field}
                                                    value={value}
                                                    onChange={(e) => field.onChange(Number(e.target.value) || 0)}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    );
                                }}
                            />

                            <FormField
                                control={form.control}
                                name="sistersCount"
                                render={({ field }) => {
                                    const value = typeof field.value === 'number' ? field.value : 0;
                                    return (
                                        <FormItem>
                                            <FormLabel>Hermanas Mujeres</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    min="0"
                                                    {...field}
                                                    value={value}
                                                    onChange={(e) => field.onChange(Number(e.target.value) || 0)}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    );
                                }} />

                            <FormField
                                control={form.control}
                                name="siblingsCount"
                                render={({ field }) => {
                                    // Convertir con casting seguro desde `form.watch(...)`
                                    const brothersCount = useWatch({ control: form.control, name: "brothersCount" });
                                    const sistersCount = useWatch({ control: form.control, name: "sistersCount" });

                                    useEffect(() => {
                                        const total = (Number(brothersCount) || 0) + (Number(sistersCount) || 0);
                                        form.setValue("siblingsCount", total);
                                    }, [brothersCount, sistersCount]);


                                    return (
                                        <FormItem>
                                            <FormLabel>Total de Hermanos</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    readOnly
                                                    value={Number(sistersCount) || 0}

                                                    className="bg-gray-100 cursor-not-allowed"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    );
                                }}
                            />
                        </div>



                        {siblingFields.map((field, index) => (
                            <div key={field.id} className="relative p-4 space-y-4 ">
                                <button
                                    type="button"
                                    onClick={() => removeSibling(index)}
                                    className="absolute top-2 right-2 text-sm text-red-600 hover:text-red-800 font-medium"
                                >
                                    <FaRegTrashAlt />
                                </button>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <FormField
                                        control={form.control}
                                        name={`siblings.${index}.name`}
                                        render={({ field }) => (
                                            <FormItem>
                                                <FormLabel>Nombre</FormLabel>
                                                <FormControl>
                                                    <Input placeholder="Nombre del hermano" {...field} value={field.value ?? ''} />
                                                </FormControl>
                                                <FormMessage />
                                            </FormItem>
                                        )}
                                    />

                                    <FormField
                                        control={form.control}
                                        name={`siblings.${index}.age`}
                                        render={({ field }) => (
                                            <FormItem>
                                                <FormLabel>Edad</FormLabel>
                                                <FormControl>
                                                    <Input
                                                        type="number"
                                                        min="0"
                                                        {...field}
                                                        onChange={(e) => field.onChange(parseInt(e.target.value))}
                                                    />
                                                </FormControl>
                                                <FormMessage />
                                            </FormItem>
                                        )}
                                    />

                                    <FormField
                                        control={form.control}
                                        name={`siblings.${index}.gender`}
                                        render={({ field }) => (
                                            <FormItem>
                                                <FormLabel>Género</FormLabel>
                                                <Select
                                                    onValueChange={field.onChange}
                                                    value={field.value ?? ""}
                                                >
                                                    <FormControl>
                                                        <SelectTrigger>
                                                            <SelectValue placeholder="Selecciona un género" />
                                                        </SelectTrigger>
                                                    </FormControl>
                                                    <SelectContent>
                                                        <SelectItem value="Masculino">Masculino</SelectItem>
                                                        <SelectItem value="Femenino">Femenino</SelectItem>

                                                    </SelectContent>
                                                </Select>
                                                <FormMessage />
                                            </FormItem>
                                        )}
                                    />


                                </div>
                            </div>
                        ))}



                        <Separator className="my-6 dark:bg-gray-700" />
                        <h2 className="text-xl font-bold col-span-full">Servicio  de Bus</h2>
                        <FormField
                            control={form.control}
                            name="busService.hasService"
                            render={({ field }) => (
                                <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                                    <FormControl>
                                        <Checkbox
                                            checked={field.value}
                                            onCheckedChange={field.onChange}
                                        />
                                    </FormControl>
                                    <div className="space-y-1 leading-none">
                                        <FormLabel>Servicio de bus</FormLabel>
                                        <FormDescription>
                                            Marque si el estudiante utiliza el servicio de bus
                                        </FormDescription>
                                    </div>
                                </FormItem>
                            )}
                        />

                        {form.watch("busService.hasService") && (

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">


                                
                            <FormField
                                control={form.control}
                                name="busService.pickupPersonName"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Nombre de la persona que recoge al estudiante</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Nombre completo" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />
                           

                            <FormField
                                control={form.control}
                                name="busService.dropoffPersonName"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Nombre de la persona que deja al estudiante</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Nombre completo" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />


                            
                            <FormField
                                control={form.control}
                                name="busService.homeAddress"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Dirección de recogida</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Dirección completa" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            <FormField
                                control={form.control}
                                name="busService.referencePoints"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Puntos de referencia</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Puntos de referencia cercanos" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}  
                            />
                            <FormField
                                control={form.control}
                                name="busService.emergencyContact"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Contacto de emergencia</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Nombre completo" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />
                            
                            <FormField
                                control={form.control}
                                name="busService.emergencyDeliveryPerson"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Persona de entrega de emergencia</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Nombre completo" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            </div>

                        )}









                        <Button type="submit" className="w-full md:w-auto">
                            Guardar Estudiante
                        </Button>
                    </form>
                </Form>

            </CardContent>
        </Card>

    )
}